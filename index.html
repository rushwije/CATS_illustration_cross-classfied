<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Rushani Wijesuriya" />

<meta name="date" content="2021-06-24" />

<title>MI approaches for incomplete three-level data with time-varying cluster-memberships</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
      a.sourceLine { display: inline-block; line-height: 1.25; }
  a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
  a.sourceLine:empty { height: 1.2em; }
  .sourceCode { overflow: visible; }
  code.sourceCode { white-space: pre; position: relative; }
  div.sourceCode { margin: 1em 0; }
  pre.sourceCode { margin: 0; }
  @media screen {
  div.sourceCode { overflow: auto; }
  }
  @media print {
  code.sourceCode { white-space: pre-wrap; }
  a.sourceLine { text-indent: -1em; padding-left: 1em; }
  }
  pre.numberSource a.sourceLine
    { position: relative; left: -4em; }
  pre.numberSource a.sourceLine::before
    { content: attr(title);
      position: relative; left: -1em; text-align: right; vertical-align: baseline;
      border: none; pointer-events: all; display: inline-block;
      -webkit-touch-callout: none; -webkit-user-select: none;
      -khtml-user-select: none; -moz-user-select: none;
      -ms-user-select: none; user-select: none;
      padding: 0 4px; width: 4em;
      color: #aaaaaa;
    }
  pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
  div.sourceCode
    {  }
  @media screen {
  a.sourceLine::before { text-decoration: underline; }
  }
  code span.al { color: #ff0000; font-weight: bold; } /* Alert */
  code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
  code span.at { color: #7d9029; } /* Attribute */
  code span.bn { color: #40a070; } /* BaseN */
  code span.bu { } /* BuiltIn */
  code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
  code span.ch { color: #4070a0; } /* Char */
  code span.cn { color: #880000; } /* Constant */
  code span.co { color: #60a0b0; font-style: italic; } /* Comment */
  code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
  code span.do { color: #ba2121; font-style: italic; } /* Documentation */
  code span.dt { color: #902000; } /* DataType */
  code span.dv { color: #40a070; } /* DecVal */
  code span.er { color: #ff0000; font-weight: bold; } /* Error */
  code span.ex { } /* Extension */
  code span.fl { color: #40a070; } /* Float */
  code span.fu { color: #06287e; } /* Function */
  code span.im { } /* Import */
  code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  code span.kw { color: #007020; font-weight: bold; } /* Keyword */
  code span.op { color: #666666; } /* Operator */
  code span.ot { color: #007020; } /* Other */
  code span.pp { color: #bc7a00; } /* Preprocessor */
  code span.sc { color: #4070a0; } /* SpecialChar */
  code span.ss { color: #bb6688; } /* SpecialString */
  code span.st { color: #4070a0; } /* String */
  code span.va { color: #19177c; } /* Variable */
  code span.vs { color: #4070a0; } /* VerbatimString */
  code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    </style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">MI approaches for incomplete three-level data with time-varying cluster-memberships</h1>
<h4 class="author">Rushani Wijesuriya</h4>
<h4 class="date">June 24, 2021</h4>



<p>This vignette provides an illustration of all MI approaches evaluated in the paper:</p>
<blockquote>
<p>Wijesuriya R., Moreno-Betancur M., Carlin J., De Silva A., and Lee K.: “Multiple imputation approaches for handling incomplete three-level data with time-varying cluster-memberships”.</p>
</blockquote>
<div id="loading-and-looking-at-the-example-dataset" class="section level2">
<h2>Loading and looking at the example dataset</h2>
<p>This illustration uses data stored <a href="https://github.com/rushwije/CATS_illustration_cross-classfied">here</a> that were simulated mimicking the dependencies in the Childhood to Adolescence Transition Study (CATS). Missing values were generated in the exposure as explained in detail in the paper, and also in the outcome and the auxiliary variable similar to the CATS with missing values assigned completely at random for simplicity. The R script for generating the example dataset can be found <a href="https://github.com/rushwije/CATS_illustration_cross-classfied/blob/main/Data%20simulation.R">here</a>.</p>
<p>The dataset contains the following variables:</p>
<ul>
<li><code>uniqueid</code>: Child’s ID</li>
<li><code>c1dage</code>: Child’s age (wave 1) (years)</li>
<li><code>cdgender</code>: Child’s sex</li>
<li><code>SES</code>: Standardized SES measured by the SEIFA IRSAD (wave 1)</li>
<li><code>tscore_W1</code>: Teacher’s numeracy score (wave 1)</li>
<li><code>school_clus.W1</code>: School cluster membership (wave 1)</li>
<li><code>time</code>: Wave</li>
<li><code>school_clus</code>: School cluster membership (waves 2,3 and 4)</li>
<li><code>t_score</code>: Teacher’s numeracy rating (waves 2,3 and 4)</li>
<li><code>prev_dep</code>: Depressive symptoms (waves 1,2 and 3)</li>
<li><code>prev_sdq</code> : Child behaviour problems reported by SDQ (waves 1,2 and 3)</li>
</ul>
<p>A detailed description of the variables and the data are provided in the main text.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="co"># Load and look</span></a>
<a class="sourceLine" id="cb1-2" title="2">CATS_dataL &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;CATS_dataL.csv&quot;</span>)</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">head</span>(CATS_dataL)</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="co">#&gt;   uniqueid   c1dage cdgender        SES tscore_W1 school_clus.W1 time</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="co">#&gt; 1        1 8.469140        0  0.1763658        NA              1    2</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="co">#&gt; 2        2 7.615096        0 -1.2741675  4.736775              1    2</span></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="co">#&gt; 3        3 9.640563        0  0.1779471  2.734524              1    2</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co">#&gt; 4        4 8.773107        1 -0.6330057  3.419223              1    2</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="co">#&gt; 5        5 7.683835        1  1.7295830  2.949518              1    2</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="co">#&gt; 6        6 7.674898        1 -0.7607554        NA              1    2</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="co">#&gt;   school_clus prev_dep  t_score prev_sdq</span></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="co">#&gt; 1           1 4.485707 3.034470 17.22987</span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="co">#&gt; 2          71 6.717121 5.748816 16.41099</span></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="co">#&gt; 3           1 3.280770 3.526214 22.78533</span></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="co">#&gt; 4          49 4.611922 4.016174 12.36164</span></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="co">#&gt; 5           1 4.498471 3.348540 13.79407</span></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="co">#&gt; 6          86 8.144683 2.555223 19.34241</span></a></code></pre></div>
</div>
<div id="loading-required-libraries" class="section level2">
<h2>Loading required libraries</h2>
<p>The following packages will be required</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">library</span>(lme4) <span class="co">#for fitting lmer</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">library</span>(dplyr)  <span class="co">##for data wrangling</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">library</span>(miceadds)  <span class="co">##for FCS-3L-ml.lmer</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">library</span>(mice)     <span class="co">##for FCS approaches (FCS-1L and FCS-2L)</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="kw">library</span>(mitml) <span class="co">#for pooling and analysing the results</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="kw">library</span>(jomo)  <span class="co">#for JM approaches(JM-1L and JM-2L)</span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="kw">library</span>(modeest)  <span class="co"># for finding the mode</span></a></code></pre></div>
<div id="available-case-analysis-aca" class="section level3">
<h3>1. Available case analysis (ACA)</h3>
<p>An ACA fitting a cross-classified random effects (CCREM) model can be conducted using the lmer function in R as shown below.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">lmer</span>(t_score<span class="op">~</span><span class="st"> </span>prev_dep<span class="op">+</span>time<span class="op">+</span>c1dage<span class="op">+</span>tscore_W1<span class="op">+</span>cdgender<span class="op">+</span>SES<span class="op">+</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="st">                    </span>(<span class="dv">1</span><span class="op">|</span>uniqueid)<span class="op">+</span>(<span class="dv">1</span><span class="op">|</span>school_clus), <span class="dt">data=</span>CATS_dataL) </a>
<a class="sourceLine" id="cb3-3" title="3"><span class="co">#&gt; Linear mixed model fit by REML [&#39;lmerMod&#39;]</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co">#&gt; Formula: t_score ~ prev_dep + time + c1dage + tscore_W1 + cdgender + SES +  </span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="co">#&gt;     (1 | uniqueid) + (1 | school_clus)</span></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co">#&gt;    Data: CATS_dataL</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co">#&gt; REML criterion at convergence: 5972.394</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="co">#&gt; Random effects:</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="co">#&gt;  Groups      Name        Std.Dev.</span></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="co">#&gt;  uniqueid    (Intercept) 0.5789  </span></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="co">#&gt;  school_clus (Intercept) 0.4176  </span></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="co">#&gt;  Residual                0.6842  </span></a>
<a class="sourceLine" id="cb3-13" title="13"><span class="co">#&gt; Number of obs: 2336, groups:  uniqueid, 1028; school_clus, 149</span></a>
<a class="sourceLine" id="cb3-14" title="14"><span class="co">#&gt; Fixed Effects:</span></a>
<a class="sourceLine" id="cb3-15" title="15"><span class="co">#&gt; (Intercept)     prev_dep         time       c1dage    tscore_W1     cdgender  </span></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="co">#&gt;     2.58958     -0.04454      0.05336     -0.17320      0.67442      0.02326  </span></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="co">#&gt;         SES  </span></a>
<a class="sourceLine" id="cb3-18" title="18"><span class="co">#&gt;     0.01124</span></a></code></pre></div>
</div>
<div id="first-cluster-approach-using-single-level-jm-with-di-for-schools-with-repeated-measures-analysed-in-wide-format-jm-1l-di-wide_f" class="section level3">
<h3>2. First-cluster approach using single-level JM with DI for schools with repeated measures analysed in wide format (JM-1L-DI-wide_f)</h3>
<p>The data used in (1) above was in long format, with one row per individual per wave. For <strong><em>JM-1L-DI-wide</em></strong>, we need to first reshape the data which into wide format with one row per individual. This can be done using the reshape function</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">  CATS_dataw &lt;-<span class="st"> </span><span class="kw">reshape</span>(CATS_dataL,<span class="dt">v.names=</span><span class="kw">c</span>(<span class="st">&quot;school_clus&quot;</span>,<span class="st">&quot;t_score&quot;</span>,<span class="st">&quot;prev_sdq&quot;</span>,<span class="st">&quot;prev_dep&quot;</span>),<span class="dt">timevar =</span> <span class="st">&quot;time&quot;</span>,<span class="dt">idvar=</span><span class="st">&quot;uniqueid&quot;</span>,<span class="dt">direction=</span> <span class="st">&quot;wide&quot;</span>)</a></code></pre></div>
<p>In order to guarantee that the correct function is being used by <code>jomo</code>, make sure that continuous variables are stored as numeric vectors in the data frame and binary/categorical variables as factors. To include fully observed categorical covariates with three or more categories in the predictor matrix (X) of the imputation model, appropriate dummy variables will have to be created.</p>
<p>Under this approach, the incomplete variables will need to be specified as the outcomes(Y) in the single level imputation model, while all complete variables will serve as the predictors(X). The imputation model can be specified as follows:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="co">#Remove school cluster indicators at waves 3 and 4 (as we are only using the cluster membership at wave 2)</span></a>
<a class="sourceLine" id="cb5-3" title="3">CATS_data_f &lt;-<span class="st"> </span><span class="kw">select</span>(CATS_dataw,<span class="op">-</span><span class="kw">c</span>(school_clus<span class="fl">.3</span>,school_clus<span class="fl">.4</span>))</a>
<a class="sourceLine" id="cb5-4" title="4"></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="co">##Set number of imputations, burn-ins and between-imputation iterations</span></a>
<a class="sourceLine" id="cb5-6" title="6">M=<span class="dv">3</span>     <span class="co">#set to 3 to reduce the time of demo, 20 more appropriate</span></a>
<a class="sourceLine" id="cb5-7" title="7">nburn=<span class="dv">1</span> <span class="co">#set to 1 to reduce the time of demo, 1000 more appropriate</span></a>
<a class="sourceLine" id="cb5-8" title="8">NB=<span class="dv">1</span>      <span class="co">#set to 1 to reduce the time of demo, 100 more appropriate  </span></a>
<a class="sourceLine" id="cb5-9" title="9"></a>
<a class="sourceLine" id="cb5-10" title="10"><span class="co">##Create a dataframe with variables to be imputed</span></a>
<a class="sourceLine" id="cb5-11" title="11">myvars &lt;-<span class="st"> </span><span class="kw">names</span>(CATS_data_f) <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;prev_dep.2&quot;</span>,<span class="st">&quot;prev_dep.3&quot;</span>,<span class="st">&quot;prev_dep.4&quot;</span>,<span class="st">&quot;tscore_W1&quot;</span>,<span class="st">&quot;t_score.2&quot;</span>,<span class="st">&quot;t_score.3&quot;</span>,<span class="st">&quot;t_score.4&quot;</span>,<span class="st">&quot;prev_sdq.2&quot;</span>,<span class="st">&quot;prev_sdq.3&quot;</span>,<span class="st">&quot;prev_sdq.4&quot;</span>)</a>
<a class="sourceLine" id="cb5-12" title="12">dataimp=CATS_data_f[myvars]</a>
<a class="sourceLine" id="cb5-13" title="13"></a>
<a class="sourceLine" id="cb5-14" title="14"><span class="co">##Create a dataframe with complete variables</span></a>
<a class="sourceLine" id="cb5-15" title="15">datacomp=<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">Intercept=</span><span class="kw">rep</span>(<span class="dv">1</span>,<span class="kw">nrow</span>(CATS_data_f)),CATS_data_f[,<span class="kw">names</span>(CATS_data_f)<span class="op">%in%</span><span class="kw">c</span>(<span class="st">&quot;SES&quot;</span>,<span class="st">&quot;c1dage&quot;</span>,<span class="st">&quot;cdgender&quot;</span>,<span class="st">&quot;school_clus.2&quot;</span>)])</a>
<a class="sourceLine" id="cb5-16" title="16"></a>
<a class="sourceLine" id="cb5-17" title="17"><span class="co">##Create school cluster dummy indicators</span></a>
<a class="sourceLine" id="cb5-18" title="18">datacomp_dummy=fastDummies<span class="op">::</span><span class="kw">dummy_cols</span>(datacomp, <span class="dt">select_columns =</span><span class="kw">c</span>(<span class="st">&quot;school_clus.2&quot;</span>),<span class="dt">remove_first_dummy =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb5-19" title="19"></a>
<a class="sourceLine" id="cb5-20" title="20"><span class="co">#Remove the orginal school cluster inidcator at wave 2 </span></a>
<a class="sourceLine" id="cb5-21" title="21">datacomp_dummy &lt;-<span class="st"> </span>datacomp_dummy <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(<span class="st">&quot;school_clus.2&quot;</span>))</a>
<a class="sourceLine" id="cb5-22" title="22"></a>
<a class="sourceLine" id="cb5-23" title="23"></a>
<a class="sourceLine" id="cb5-24" title="24"><span class="co">##Perform imputations without the random effects (single-level imputation)</span></a>
<a class="sourceLine" id="cb5-25" title="25">imp1&lt;-<span class="kw">jomo1con</span>(<span class="dt">Y=</span>dataimp, <span class="dt">X=</span>datacomp_dummy, <span class="dt">nimp=</span>M,<span class="dt">nburn=</span>nburn,<span class="dt">nbetween=</span>NB,<span class="kw">set.seed</span>(<span class="dv">291002</span>))</a>
<a class="sourceLine" id="cb5-26" title="26"><span class="co">#output not shown  to reduce length of vignette</span></a></code></pre></div>
<p>After imputation, the imputed datasets will need to be reshaped into long format and the orginal school cluster memberships (which are time-varying) will need to be reattached before fitting the substantive analysis model.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">mylist=<span class="kw">list</span>()</a>
<a class="sourceLine" id="cb6-2" title="2"></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="cf">for</span>(m <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>M)</a>
<a class="sourceLine" id="cb6-4" title="4">{</a>
<a class="sourceLine" id="cb6-5" title="5">  <span class="co">#1.Extract the mth imputed dataset</span></a>
<a class="sourceLine" id="cb6-6" title="6">  datw&lt;-imp1[imp1<span class="op">$</span>Imputation<span class="op">==</span>m,]</a>
<a class="sourceLine" id="cb6-7" title="7">  </a>
<a class="sourceLine" id="cb6-8" title="8">  <span class="co">#2.Remove indicator variables and other unwanted variables</span></a>
<a class="sourceLine" id="cb6-9" title="9">  datw=datw <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">!</span><span class="kw">contains</span>(<span class="kw">c</span>(<span class="st">&quot;school_clus.&quot;</span>,<span class="st">&quot;sdq&quot;</span>)),<span class="op">-</span>Intercept,<span class="op">-</span>Imputation)</a>
<a class="sourceLine" id="cb6-10" title="10">  </a>
<a class="sourceLine" id="cb6-11" title="11">  <span class="co">#3.Reattach the school variable and remove school indicator variables</span></a>
<a class="sourceLine" id="cb6-12" title="12">  datw=<span class="kw">cbind</span>(datw,CATS_dataw<span class="op">$</span>school_clus<span class="fl">.2</span>,CATS_dataw<span class="op">$</span>school_clus<span class="fl">.3</span>,CATS_dataw<span class="op">$</span>school_clus<span class="fl">.4</span>)</a>
<a class="sourceLine" id="cb6-13" title="13">  </a>
<a class="sourceLine" id="cb6-14" title="14">  <span class="co">#4.Remove unwanted variables</span></a>
<a class="sourceLine" id="cb6-15" title="15">  datw=datw <span class="op">%&gt;%</span>dplyr<span class="op">::</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">school_clus.2=</span><span class="st">&quot;CATS_dataw$school_clus.2&quot;</span>,<span class="dt">school_clus.3=</span><span class="st">&quot;CATS_dataw$school_clus.3&quot;</span>,</a>
<a class="sourceLine" id="cb6-16" title="16">                       <span class="dt">school_clus.4=</span><span class="st">&quot;CATS_dataw$school_clus.4&quot;</span>)</a>
<a class="sourceLine" id="cb6-17" title="17">  </a>
<a class="sourceLine" id="cb6-18" title="18">  <span class="co">#5.Reshape to long</span></a>
<a class="sourceLine" id="cb6-19" title="19">  datL=<span class="kw">reshape</span>(datw,<span class="dt">varying =</span><span class="kw">list</span>(<span class="kw">c</span>(<span class="st">&quot;prev_dep.2&quot;</span>,<span class="st">&quot;prev_dep.3&quot;</span>,<span class="st">&quot;prev_dep.4&quot;</span>),</a>
<a class="sourceLine" id="cb6-20" title="20">                                  <span class="kw">c</span>(<span class="st">&quot;t_score.2&quot;</span>,<span class="st">&quot;t_score.3&quot;</span>,<span class="st">&quot;t_score.4&quot;</span>),</a>
<a class="sourceLine" id="cb6-21" title="21">                                  <span class="kw">c</span>(<span class="st">&quot;school_clus.2&quot;</span>,<span class="st">&quot;school_clus.3&quot;</span>,<span class="st">&quot;school_clus.4&quot;</span>)),<span class="dt">idvar=</span><span class="st">&quot;id&quot;</span>, </a>
<a class="sourceLine" id="cb6-22" title="22">               <span class="dt">v.names=</span><span class="kw">c</span>(<span class="st">&quot;prev_dep&quot;</span>,<span class="st">&quot;t_score&quot;</span>,<span class="st">&quot;school_clus&quot;</span>), <span class="dt">times=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>),<span class="dt">direction=</span> <span class="st">&quot;long&quot;</span>)</a>
<a class="sourceLine" id="cb6-23" title="23">  </a>
<a class="sourceLine" id="cb6-24" title="24">  datL &lt;-<span class="st"> </span>datL[<span class="kw">order</span>(datL<span class="op">$</span>school,datL<span class="op">$</span>id),]    </a>
<a class="sourceLine" id="cb6-25" title="25">  </a>
<a class="sourceLine" id="cb6-26" title="26">  <span class="co">#6.save the datasets in a list</span></a>
<a class="sourceLine" id="cb6-27" title="27">  mylist[[m]]=<span class="st"> </span>datL</a>
<a class="sourceLine" id="cb6-28" title="28">}</a></code></pre></div>
<p>For fitting the analysis model on the imputed datasets and pooling the results, the `mitml’ package can be used.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="co">#Fit the analysis of interest on the imputed datasets </span></a>
<a class="sourceLine" id="cb7-3" title="3">mods &lt;-<span class="st"> </span><span class="kw">lapply</span>(mylist,<span class="cf">function</span>(d) {<span class="kw">lmer</span>(t_score<span class="op">~</span><span class="st"> </span>prev_dep<span class="op">+</span>time<span class="op">+</span>c1dage<span class="op">+</span>tscore_W1<span class="op">+</span>cdgender<span class="op">+</span>SES<span class="op">+</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="st">                                          </span>(<span class="dv">1</span><span class="op">|</span>id)<span class="op">+</span>(<span class="dv">1</span><span class="op">|</span>school_clus), <span class="dt">data=</span>d) } )</a>
<a class="sourceLine" id="cb7-5" title="5"><span class="kw">testEstimates</span>(mods,<span class="dt">var.comp=</span>T)</a>
<a class="sourceLine" id="cb7-6" title="6"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-7" title="7"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb7-8" title="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-9" title="9"><span class="co">#&gt; testEstimates(model = mods, var.comp = T)</span></a>
<a class="sourceLine" id="cb7-10" title="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-11" title="11"><span class="co">#&gt; Final parameter estimates and inferences obtained from 3 imputed data sets.</span></a>
<a class="sourceLine" id="cb7-12" title="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-13" title="13"><span class="co">#&gt;               Estimate  Std.Error    t.value         df    P(&gt;|t|)        RIV        FMI </span></a>
<a class="sourceLine" id="cb7-14" title="14"><span class="co">#&gt; (Intercept)      2.614      0.278      9.397     25.398      0.000      0.390      0.331 </span></a>
<a class="sourceLine" id="cb7-15" title="15"><span class="co">#&gt; prev_dep        -0.027      0.009     -2.964   1623.194      0.003      0.036      0.036 </span></a>
<a class="sourceLine" id="cb7-16" title="16"><span class="co">#&gt; time             0.039      0.015      2.545 513309.275      0.011      0.002      0.002 </span></a>
<a class="sourceLine" id="cb7-17" title="17"><span class="co">#&gt; c1dage          -0.190      0.026     -7.245     78.992      0.000      0.189      0.180 </span></a>
<a class="sourceLine" id="cb7-18" title="18"><span class="co">#&gt; tscore_W1        0.666      0.026     25.709     14.192      0.000      0.601      0.448 </span></a>
<a class="sourceLine" id="cb7-19" title="19"><span class="co">#&gt; cdgender         0.054      0.045      1.207    210.131      0.229      0.108      0.106 </span></a>
<a class="sourceLine" id="cb7-20" title="20"><span class="co">#&gt; SES              0.006      0.022      0.276  15140.482      0.782      0.012      0.012 </span></a>
<a class="sourceLine" id="cb7-21" title="21"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-22" title="22"><span class="co">#&gt;                                  Estimate </span></a>
<a class="sourceLine" id="cb7-23" title="23"><span class="co">#&gt; Intercept~~Intercept|id             0.347 </span></a>
<a class="sourceLine" id="cb7-24" title="24"><span class="co">#&gt; Intercept~~Intercept|school_clus    0.218 </span></a>
<a class="sourceLine" id="cb7-25" title="25"><span class="co">#&gt; Residual~~Residual                  0.515 </span></a>
<a class="sourceLine" id="cb7-26" title="26"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-27" title="27"><span class="co">#&gt; Unadjusted hypothesis test as appropriate in larger samples.</span></a></code></pre></div>
</div>
<div id="first-cluster-approach-using-single-level-fcs-with-di-for-schools-with-repeated-measures-analysed-in-wide-format-fcs-1l-di-wide_f" class="section level3">
<h3>3. First-cluster approach using single-level FCS with DI for schools with repeated measures analysed in wide format (FCS-1L-DI-wide_f)</h3>
<p>Similar to the <strong><em>JM-1L-DI-wide_f</em></strong> approach, here the dataset will need to be in wide format during the imputation process. To carry out single-level FCS, R package <code>mice</code> can be used. As all incomplete variables are continuous, the method used is <code>norm</code>. More details on methods within <code>mice</code> for different types of variables can be found <a href="https://stefvanbuuren.name/fimd/">here</a>. Here each of the incomplete variable will be imputed by using a series of univariate imputation models with the incomplete variable as the outcome and all the other variables as the predictors.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="co">##Set the number of imputations </span></a>
<a class="sourceLine" id="cb8-3" title="3">M&lt;-<span class="dv">3</span>     <span class="co">#set to 3 to reduce the time of demo, 20 more appropriate</span></a>
<a class="sourceLine" id="cb8-4" title="4"></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="co">##Recode school cluster at wave 2 as a categorical variable</span></a>
<a class="sourceLine" id="cb8-6" title="6">CATS_dataw<span class="op">$</span>school_clus<span class="fl">.2</span>=<span class="kw">as.factor</span>(CATS_dataw<span class="op">$</span>school_clus<span class="fl">.2</span>)</a>
<a class="sourceLine" id="cb8-7" title="7"></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="co">#Generate the predictor matrix</span></a>
<a class="sourceLine" id="cb8-9" title="9">pred &lt;-<span class="st"> </span>mice<span class="op">::</span><span class="kw">make.predictorMatrix</span>(CATS_dataw)</a>
<a class="sourceLine" id="cb8-10" title="10"></a>
<a class="sourceLine" id="cb8-11" title="11"><span class="co">#In the predictor matrix, a value of</span></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="co">#0: Indicates that the column variable is not used as predictor for the row variable</span></a>
<a class="sourceLine" id="cb8-13" title="13"><span class="co">#1: Indicates that the column variable is used as a predcitor with a fixed effect for the row variable</span></a>
<a class="sourceLine" id="cb8-14" title="14"><span class="co">#2:  Indicates that the column variable is used as a predcitor with a fixed and a random effect for the row variable</span></a>
<a class="sourceLine" id="cb8-15" title="15"><span class="co">#-2:  Indicates that column variable is the cluster/group variable (Only one variable is allowed)</span></a>
<a class="sourceLine" id="cb8-16" title="16">pred[,<span class="kw">c</span>(<span class="st">&quot;school_clus.3&quot;</span>,<span class="st">&quot;school_clus.4&quot;</span>,<span class="st">&quot;uniqueid&quot;</span>)] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb8-17" title="17"></a>
<a class="sourceLine" id="cb8-18" title="18"><span class="co">##Perform imputations</span></a>
<a class="sourceLine" id="cb8-19" title="19">imp2=<span class="kw">mice</span>(<span class="dt">data=</span>CATS_dataw, <span class="dt">predictorMatrix =</span> pred,<span class="dt">m=</span>M,<span class="dt">method=</span><span class="st">&quot;norm&quot;</span>,<span class="dt">maxit=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-20" title="20"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb8-21" title="21"><span class="co">#&gt;  iter imp variable</span></a>
<a class="sourceLine" id="cb8-22" title="22"><span class="co">#&gt;   1   1  tscore_W1  t_score.2  prev_sdq.2  prev_dep.2  t_score.3  prev_sdq.3  prev_dep.3  t_score.4  prev_sdq.4  prev_dep.4</span></a>
<a class="sourceLine" id="cb8-23" title="23"><span class="co">#&gt;   1   2  tscore_W1  t_score.2  prev_sdq.2  prev_dep.2  t_score.3  prev_sdq.3  prev_dep.3  t_score.4  prev_sdq.4  prev_dep.4</span></a>
<a class="sourceLine" id="cb8-24" title="24"><span class="co">#&gt;   1   3  tscore_W1  t_score.2  prev_sdq.2  prev_dep.2  t_score.3  prev_sdq.3  prev_dep.3  t_score.4  prev_sdq.4  prev_dep.4</span></a>
<a class="sourceLine" id="cb8-25" title="25"><span class="co">#&gt; Warning: Number of logged events: 30</span></a></code></pre></div>
<p>Similar to <strong><em>JM-1L-DI-wide_f</em></strong>, after imputation, the imputed datasets will need to be reshaped into long format before fitting the substantive analysis model.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"></a>
<a class="sourceLine" id="cb9-2" title="2">mylist=<span class="kw">list</span>()</a>
<a class="sourceLine" id="cb9-3" title="3"></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="cf">for</span>(m <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>M)</a>
<a class="sourceLine" id="cb9-5" title="5">{</a>
<a class="sourceLine" id="cb9-6" title="6">  <span class="co">#1. Extract the mth imputed dataset</span></a>
<a class="sourceLine" id="cb9-7" title="7">  datw&lt;-mice<span class="op">::</span><span class="kw">complete</span>(imp2,m)</a>
<a class="sourceLine" id="cb9-8" title="8">  </a>
<a class="sourceLine" id="cb9-9" title="9">  <span class="co">#2. Remove unwanted variables</span></a>
<a class="sourceLine" id="cb9-10" title="10">  datw=datw <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">!</span><span class="kw">contains</span>(<span class="st">&quot;sdq&quot;</span>))</a>
<a class="sourceLine" id="cb9-11" title="11">  </a>
<a class="sourceLine" id="cb9-12" title="12">  <span class="co">#3. Recode school cluster at waves 3 and 4 as a categorical variable</span></a>
<a class="sourceLine" id="cb9-13" title="13">  datw[,<span class="kw">c</span>(<span class="st">&quot;school_clus.3&quot;</span>,<span class="st">&quot;school_clus.4&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">lapply</span>(datw[,<span class="kw">c</span>(<span class="st">&quot;school_clus.3&quot;</span>,<span class="st">&quot;school_clus.4&quot;</span>)] , factor)</a>
<a class="sourceLine" id="cb9-14" title="14">  </a>
<a class="sourceLine" id="cb9-15" title="15">  <span class="co">#4. Reshape to long</span></a>
<a class="sourceLine" id="cb9-16" title="16">  datL=<span class="kw">reshape</span>(datw,<span class="dt">varying =</span><span class="kw">list</span>(<span class="kw">c</span>(<span class="st">&quot;prev_dep.2&quot;</span>,<span class="st">&quot;prev_dep.3&quot;</span>,<span class="st">&quot;prev_dep.4&quot;</span>), <span class="kw">c</span>(<span class="st">&quot;t_score.2&quot;</span>,<span class="st">&quot;t_score.3&quot;</span>,<span class="st">&quot;t_score.4&quot;</span>),<span class="kw">c</span>(<span class="st">&quot;school_clus.2&quot;</span>,<span class="st">&quot;school_clus.3&quot;</span>,<span class="st">&quot;school_clus.4&quot;</span>)),<span class="dt">idvar=</span><span class="st">&quot;uniqueid&quot;</span>,<span class="dt">v.names=</span><span class="kw">c</span>(<span class="st">&quot;prev_dep&quot;</span>,<span class="st">&quot;t_score&quot;</span>,<span class="st">&quot;school_clus&quot;</span>), <span class="dt">times=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>),<span class="dt">direction=</span> <span class="st">&quot;long&quot;</span>)</a>
<a class="sourceLine" id="cb9-17" title="17">  </a>
<a class="sourceLine" id="cb9-18" title="18">  datL &lt;-<span class="st"> </span>datL[<span class="kw">order</span>(datL<span class="op">$</span>uniqueid),]    </a>
<a class="sourceLine" id="cb9-19" title="19">  </a>
<a class="sourceLine" id="cb9-20" title="20">  <span class="co">#5. Save the dataset in a list</span></a>
<a class="sourceLine" id="cb9-21" title="21">  mylist[[m]]=<span class="st"> </span>datL</a>
<a class="sourceLine" id="cb9-22" title="22">}</a></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="co">#Fit the analysis of interest on the imputed datasets </span></a>
<a class="sourceLine" id="cb10-3" title="3">mods &lt;-<span class="st"> </span><span class="kw">lapply</span>(mylist,<span class="cf">function</span>(d) {<span class="kw">lmer</span>(t_score<span class="op">~</span><span class="st"> </span>prev_dep<span class="op">+</span>time<span class="op">+</span>c1dage<span class="op">+</span>tscore_W1<span class="op">+</span>cdgender<span class="op">+</span>SES<span class="op">+</span></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="st">                                          </span>(<span class="dv">1</span><span class="op">|</span>uniqueid)<span class="op">+</span>(<span class="dv">1</span><span class="op">|</span>school_clus), <span class="dt">data=</span>d) } )</a>
<a class="sourceLine" id="cb10-5" title="5"><span class="kw">testEstimates</span>(mods,<span class="dt">var.comp=</span>T)</a>
<a class="sourceLine" id="cb10-6" title="6"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-7" title="7"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb10-8" title="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-9" title="9"><span class="co">#&gt; testEstimates(model = mods, var.comp = T)</span></a>
<a class="sourceLine" id="cb10-10" title="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-11" title="11"><span class="co">#&gt; Final parameter estimates and inferences obtained from 3 imputed data sets.</span></a>
<a class="sourceLine" id="cb10-12" title="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-13" title="13"><span class="co">#&gt;                Estimate   Std.Error     t.value          df     P(&gt;|t|)         RIV         FMI </span></a>
<a class="sourceLine" id="cb10-14" title="14"><span class="co">#&gt; (Intercept)       2.641       0.237      11.123    5487.073       0.000       0.019       0.019 </span></a>
<a class="sourceLine" id="cb10-15" title="15"><span class="co">#&gt; prev_dep         -0.033       0.010      -3.470      97.648       0.001       0.167       0.160 </span></a>
<a class="sourceLine" id="cb10-16" title="16"><span class="co">#&gt; time              0.033       0.015       2.183    8419.786       0.029       0.016       0.016 </span></a>
<a class="sourceLine" id="cb10-17" title="17"><span class="co">#&gt; c1dage           -0.194       0.024      -8.013    4786.663       0.000       0.021       0.021 </span></a>
<a class="sourceLine" id="cb10-18" title="18"><span class="co">#&gt; tscore_W1         0.680       0.024      28.357      30.366       0.000       0.345       0.301 </span></a>
<a class="sourceLine" id="cb10-19" title="19"><span class="co">#&gt; cdgender          0.032       0.043       0.754   20559.625       0.451       0.010       0.010 </span></a>
<a class="sourceLine" id="cb10-20" title="20"><span class="co">#&gt; SES               0.005       0.021       0.230 5224501.334       0.818       0.001       0.001 </span></a>
<a class="sourceLine" id="cb10-21" title="21"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-22" title="22"><span class="co">#&gt;                                  Estimate </span></a>
<a class="sourceLine" id="cb10-23" title="23"><span class="co">#&gt; Intercept~~Intercept|uniqueid       0.346 </span></a>
<a class="sourceLine" id="cb10-24" title="24"><span class="co">#&gt; Intercept~~Intercept|school_clus    0.180 </span></a>
<a class="sourceLine" id="cb10-25" title="25"><span class="co">#&gt; Residual~~Residual                  0.512 </span></a>
<a class="sourceLine" id="cb10-26" title="26"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-27" title="27"><span class="co">#&gt; Unadjusted hypothesis test as appropriate in larger samples.</span></a></code></pre></div>
</div>
<div id="first-cluster-approach-using-three-level-fcs-approach-in-blimp-fcs-3l-blimp_f" class="section level3">
<h3>4. First-cluster approach using three-level FCS approach in Blimp (FCS-3L-Blimp_f)</h3>
<p>The syntax file for conducting imputations under this approach can be found <a href="https://github.com/rushwije/MI3level_cross-classfied">here</a>.</p>
<p><strong>Note</strong>: Prior to importing data to the Blimp-studio software, recode all missing values (for example as 999) and categorical variables as numerical variables. This is because special characters in the data such as NA values and string values can cause the data import to fail. The user guide, examples and the new version releases for the Blimp-studio software can be found <a href="http://www.appliedmissingdata.com/multilevel-imputation.html">here</a>.</p>
<p>The multiple imputed datasets will be saved in a single file in a stacked format.The substantive model then needs to be fitted to each imputed dataset and results pooled across the datasets.</p>
</div>
<div id="common-cluster-approach-using-single-level-jm-with-di-for-schools-with-repeated-measures-analysed-in-wide-format-jm-1l-di-wide_c" class="section level3">
<h3>5. Common-cluster approach using single-level JM with DI for schools with repeated measures analysed in wide format (JM-1L-DI-wide_c)</h3>
<p>The imputation procedure and the syntax under this approach is similar to <strong><em>JM-1L-DI-wide_f</em></strong> except here prior to imputations, the mode of the school cluster membership at waves 2,3 and 4 will need to be computed to be used as the school cluster membership for each individual.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"></a>
<a class="sourceLine" id="cb11-2" title="2">CATS_datam=CATS_dataw</a>
<a class="sourceLine" id="cb11-3" title="3"></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="co">##Generate school cluster indicator (mode of school clus at 2,3,and 4)</span></a>
<a class="sourceLine" id="cb11-5" title="5">School_clusters=CATS_datam <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(school_clus<span class="fl">.2</span>,school_clus<span class="fl">.3</span>,school_clus<span class="fl">.4</span>)</a>
<a class="sourceLine" id="cb11-6" title="6"></a>
<a class="sourceLine" id="cb11-7" title="7"><span class="co">##Find the mode and attach it to CATS_data</span></a>
<a class="sourceLine" id="cb11-8" title="8">CATS_datam<span class="op">$</span>schoolclus_mode=<span class="kw">apply</span>(School_clusters,<span class="dv">1</span>,mfv1)</a>
<a class="sourceLine" id="cb11-9" title="9"></a>
<a class="sourceLine" id="cb11-10" title="10"><span class="co">##Set number of imputations, burn-ins and the between imputation iterations</span></a>
<a class="sourceLine" id="cb11-11" title="11">M=<span class="dv">3</span>     <span class="co">#set to 3 to reduce the time of demo, 20 more appropriate</span></a>
<a class="sourceLine" id="cb11-12" title="12">nburn=<span class="dv">1</span> <span class="co">#set to 1 to reduce the time of demo, 1000 more appropriate</span></a>
<a class="sourceLine" id="cb11-13" title="13">NB=<span class="dv">1</span>      <span class="co">#set to 1 to reduce the time of demo, 100 more appropriate  </span></a>
<a class="sourceLine" id="cb11-14" title="14"></a>
<a class="sourceLine" id="cb11-15" title="15">myvars &lt;-<span class="st"> </span><span class="kw">names</span>(CATS_datam) <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;prev_dep.2&quot;</span>,<span class="st">&quot;prev_dep.3&quot;</span>,<span class="st">&quot;prev_dep.4&quot;</span>,<span class="st">&quot;tscore_W1&quot;</span>,<span class="st">&quot;t_score.2&quot;</span>,<span class="st">&quot;t_score.3&quot;</span>,<span class="st">&quot;t_score.4&quot;</span>,<span class="st">&quot;prev_sdq.2&quot;</span>,<span class="st">&quot;prev_sdq.3&quot;</span>,<span class="st">&quot;prev_sdq.4&quot;</span> ) </a>
<a class="sourceLine" id="cb11-16" title="16">dataimp=CATS_datam[myvars]</a>
<a class="sourceLine" id="cb11-17" title="17"></a>
<a class="sourceLine" id="cb11-18" title="18"><span class="co">##Create a dataframe with complete variables</span></a>
<a class="sourceLine" id="cb11-19" title="19">datacomp=<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">Intercept=</span><span class="kw">rep</span>(<span class="dv">1</span>,<span class="kw">nrow</span>(CATS_datam)),</a>
<a class="sourceLine" id="cb11-20" title="20">                CATS_datam[,<span class="kw">names</span>(CATS_datam)<span class="op">%in%</span><span class="kw">c</span>(<span class="st">&quot;SES&quot;</span>,<span class="st">&quot;c1dage&quot;</span>,<span class="st">&quot;cdgender&quot;</span>,<span class="st">&quot;schoolclus_mode&quot;</span>)])</a>
<a class="sourceLine" id="cb11-21" title="21"></a>
<a class="sourceLine" id="cb11-22" title="22"><span class="co">##Create school dummy indicators</span></a>
<a class="sourceLine" id="cb11-23" title="23">datacomp_dummy=fastDummies<span class="op">::</span><span class="kw">dummy_cols</span>(datacomp, <span class="dt">select_columns =</span><span class="kw">c</span>(<span class="st">&quot;schoolclus_mode&quot;</span>),<span class="dt">remove_first_dummy =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb11-24" title="24"></a>
<a class="sourceLine" id="cb11-25" title="25"><span class="co">#Remove the original school cluster indicators </span></a>
<a class="sourceLine" id="cb11-26" title="26">datacomp_dummy &lt;-<span class="st"> </span>datacomp_dummy <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(<span class="st">&quot;schoolclus_mode&quot;</span>))</a>
<a class="sourceLine" id="cb11-27" title="27"></a>
<a class="sourceLine" id="cb11-28" title="28"><span class="co">##Perform imputations without the random effects (SL imputation)</span></a>
<a class="sourceLine" id="cb11-29" title="29">imp3&lt;-<span class="kw">jomo1con</span>(<span class="dt">Y=</span>dataimp, <span class="dt">X=</span>datacomp_dummy, <span class="dt">nimp=</span>M,<span class="dt">nburn=</span>nburn,<span class="dt">nbetween=</span>NB, <span class="kw">set.seed</span>(<span class="dv">278100</span>))</a>
<a class="sourceLine" id="cb11-30" title="30"><span class="co">#output not shown  to reduce length of vignette</span></a></code></pre></div>
<p>After imputation, the imputed datasets will need to be reshaped into long format and the orginal school cluster memberships will need to be reattached before fitting the substantive analysis model as before.</p>
</div>
<div id="common-cluster-approach-using-single-level-fcs-with-di-for-schools-with-repeated-measures-analysed-in-wide-format-fcs-1l-di-wide_c" class="section level3">
<h3>6. Common-cluster approach using single-level FCS with DI for schools with repeated measures analysed in wide format (FCS-1L-DI-wide_c)</h3>
<p>The imputation procedure and the syntax under this approach is similar to <strong><em>FCS-1L-DI-wide_f</em></strong> except here the mode of the school cluster membership at waves 2,3 and 4 will be used as the school cluster membership for each individual.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"></a>
<a class="sourceLine" id="cb12-2" title="2">CATS_datamFCS &lt;-<span class="st"> </span>CATS_dataw</a>
<a class="sourceLine" id="cb12-3" title="3"></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="co">##Generate school cluster indicator (mode of school clus at 2,3,and 4)</span></a>
<a class="sourceLine" id="cb12-5" title="5">School_clusters=CATS_dataw <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(school_clus<span class="fl">.2</span>,school_clus<span class="fl">.3</span>,school_clus<span class="fl">.4</span>)</a>
<a class="sourceLine" id="cb12-6" title="6"></a>
<a class="sourceLine" id="cb12-7" title="7"><span class="co">##Find the mode and attach it to CATS_data</span></a>
<a class="sourceLine" id="cb12-8" title="8">CATS_datamFCS<span class="op">$</span>schoolclus_mode=<span class="kw">apply</span>(School_clusters,<span class="dv">1</span>,mfv1)</a>
<a class="sourceLine" id="cb12-9" title="9">CATS_datamFCS<span class="op">$</span>schoolclus_mode=<span class="kw">as.factor</span>(CATS_datamFCS<span class="op">$</span>schoolclus_mode)</a>
<a class="sourceLine" id="cb12-10" title="10"></a>
<a class="sourceLine" id="cb12-11" title="11"><span class="co">##Set number of imputations and number of burn-in iterations</span></a>
<a class="sourceLine" id="cb12-12" title="12">M&lt;-<span class="dv">3</span>     <span class="co">#set to 3 to reduce the time of demo, 20 more appropriate</span></a>
<a class="sourceLine" id="cb12-13" title="13"></a>
<a class="sourceLine" id="cb12-14" title="14"><span class="co">##Generate the predictor matrix</span></a>
<a class="sourceLine" id="cb12-15" title="15">pred &lt;-<span class="st"> </span>mice<span class="op">::</span><span class="kw">make.predictorMatrix</span>(CATS_datamFCS)</a>
<a class="sourceLine" id="cb12-16" title="16"></a>
<a class="sourceLine" id="cb12-17" title="17"><span class="co">#In the predictor matrix, a value of</span></a>
<a class="sourceLine" id="cb12-18" title="18"><span class="co">#0: Indicates that the column variable is not used as predictor for the row variable</span></a>
<a class="sourceLine" id="cb12-19" title="19"><span class="co">#1: Indicates that the column variable is used as a predcitor with a fixed effect for the row variable</span></a>
<a class="sourceLine" id="cb12-20" title="20"><span class="co">#2:  Indicates that the column variable is used as a predcitor with a fixed and a random effect for the row variable</span></a>
<a class="sourceLine" id="cb12-21" title="21"><span class="co">#-2:  Indicates that column variable is the cluster/group variable (Only one variable is allowed)</span></a>
<a class="sourceLine" id="cb12-22" title="22">pred[,<span class="kw">c</span>(<span class="st">&quot;school_clus.2&quot;</span>,<span class="st">&quot;school_clus.3&quot;</span>,<span class="st">&quot;school_clus.4&quot;</span>,<span class="st">&quot;uniqueid&quot;</span>)] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb12-23" title="23"></a>
<a class="sourceLine" id="cb12-24" title="24"><span class="co">##Perform imputations</span></a>
<a class="sourceLine" id="cb12-25" title="25">imp4=<span class="kw">mice</span>(<span class="dt">data=</span>CATS_datamFCS, <span class="dt">predictorMatrix =</span> pred,<span class="dt">m=</span>M,<span class="dt">method=</span><span class="st">&quot;norm&quot;</span>,<span class="dt">maxit=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb12-26" title="26"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb12-27" title="27"><span class="co">#&gt;  iter imp variable</span></a>
<a class="sourceLine" id="cb12-28" title="28"><span class="co">#&gt;   1   1  tscore_W1  t_score.2  prev_sdq.2  prev_dep.2  t_score.3  prev_sdq.3  prev_dep.3  t_score.4  prev_sdq.4  prev_dep.4</span></a>
<a class="sourceLine" id="cb12-29" title="29"><span class="co">#&gt;   1   2  tscore_W1  t_score.2  prev_sdq.2  prev_dep.2  t_score.3  prev_sdq.3  prev_dep.3  t_score.4  prev_sdq.4  prev_dep.4</span></a>
<a class="sourceLine" id="cb12-30" title="30"><span class="co">#&gt;   1   3  tscore_W1  t_score.2  prev_sdq.2  prev_dep.2  t_score.3  prev_sdq.3  prev_dep.3  t_score.4  prev_sdq.4  prev_dep.4</span></a>
<a class="sourceLine" id="cb12-31" title="31"><span class="co">#&gt; Warning: Number of logged events: 30</span></a></code></pre></div>
<p>Post-imputation, the imputed datasets will need to be reshaped into long format and the orginal school cluster memberships will need to be reattached before fitting the substantive analysis model as before</p>
</div>
<div id="common-cluster-approach-using-three-level-fcs-approach-in-blimp-fcs-3l-blimp_c" class="section level3">
<h3>7. Common-cluster approach using three-level FCS approach in Blimp (FCS-3L-Blimp_c)</h3>
<p>For the syntax file see <a href="https://github.com/rushwije/MI3level_cross-classfied">here</a>.</p>
</div>
<div id="single-level-fcs-with-di-indicators-for-the-higher-level-clusters-and-repeated-measures-imputed-in-wide-format-fcs-1l-di-wide" class="section level3">
<h3>8. Single-level FCS with DI indicators for the higher-level clusters and repeated measures imputed in wide format (FCS-1L-DI-wide)</h3>
<p>Under this approah, each of the incomplete variables will be imputed by using a series of univariate imputation models with the incomplete variable as the outcome and all the other variables as the predictors. In each of the univariate imputation models specified for each incomplete repeated measure a set of DIs for the school cluster membership at that particular wave will be included. This is achieved using the predictor matrix as shown below.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"></a>
<a class="sourceLine" id="cb13-2" title="2">CATS_dataFCSv &lt;-<span class="st"> </span>CATS_dataw</a>
<a class="sourceLine" id="cb13-3" title="3"></a>
<a class="sourceLine" id="cb13-4" title="4"><span class="co">##Set number of imputations </span></a>
<a class="sourceLine" id="cb13-5" title="5">M&lt;-<span class="dv">3</span>   <span class="co">#set to 3 to reduce the time of demo, 20 more appropriate</span></a>
<a class="sourceLine" id="cb13-6" title="6"></a>
<a class="sourceLine" id="cb13-7" title="7"><span class="co">##Recode school cluster at wave 2 as categorical </span></a>
<a class="sourceLine" id="cb13-8" title="8">CATS_dataFCSv[,<span class="kw">c</span>(<span class="st">&quot;school_clus.W1&quot;</span>,<span class="st">&quot;school_clus.2&quot;</span>,<span class="st">&quot;school_clus.3&quot;</span>,<span class="st">&quot;school_clus.4&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">lapply</span>(CATS_dataFCSv[,<span class="kw">c</span>(<span class="st">&quot;school_clus.W1&quot;</span>,<span class="st">&quot;school_clus.2&quot;</span>,<span class="st">&quot;school_clus.3&quot;</span>,<span class="st">&quot;school_clus.4&quot;</span>)] , factor)</a>
<a class="sourceLine" id="cb13-9" title="9"></a>
<a class="sourceLine" id="cb13-10" title="10"></a>
<a class="sourceLine" id="cb13-11" title="11"><span class="co">#Generate the predictor matrix</span></a>
<a class="sourceLine" id="cb13-12" title="12">pred &lt;-<span class="st"> </span>mice<span class="op">::</span><span class="kw">make.predictorMatrix</span>(CATS_dataFCSv)</a>
<a class="sourceLine" id="cb13-13" title="13"></a>
<a class="sourceLine" id="cb13-14" title="14"><span class="co">#In the predictor matrix, a value of</span></a>
<a class="sourceLine" id="cb13-15" title="15"><span class="co">#0: Indicates that the column variable is not used as predictor for the row variable</span></a>
<a class="sourceLine" id="cb13-16" title="16"><span class="co">#1: Indicates that the column variable is used as a predcitor with a fixed effect for the row variable</span></a>
<a class="sourceLine" id="cb13-17" title="17"><span class="co">#2:  Indicates that the column variable is used as a predcitor with a fixed and a random effect for the row variable</span></a>
<a class="sourceLine" id="cb13-18" title="18"><span class="co">#-2:  Indicates that column variable is the cluster/group variable (Only one variable is allowed)</span></a>
<a class="sourceLine" id="cb13-19" title="19"></a>
<a class="sourceLine" id="cb13-20" title="20">pred[,<span class="st">&quot;uniqueid&quot;</span>] &lt;-<span class="st"> </span><span class="dv">0</span>  </a>
<a class="sourceLine" id="cb13-21" title="21"></a>
<a class="sourceLine" id="cb13-22" title="22"><span class="co">#set the cluster membership for each incomplete repeated measure selectively in the predictor matrix</span></a>
<a class="sourceLine" id="cb13-23" title="23">pred[<span class="kw">c</span>(<span class="st">&quot;prev_dep.2&quot;</span>,<span class="st">&quot;t_score.2&quot;</span>,<span class="st">&quot;prev_sdq.2&quot;</span>),<span class="kw">c</span>(<span class="st">&quot;school_clus.W1&quot;</span>,<span class="st">&quot;school_clus.3&quot;</span>,<span class="st">&quot;school_clus.4&quot;</span>)]&lt;-<span class="dv">0</span>  </a>
<a class="sourceLine" id="cb13-24" title="24">pred[<span class="kw">c</span>(<span class="st">&quot;prev_dep.3&quot;</span>,<span class="st">&quot;t_score.3&quot;</span>,<span class="st">&quot;prev_sdq.3&quot;</span>),<span class="kw">c</span>(<span class="st">&quot;school_clus.W1&quot;</span>,<span class="st">&quot;school_clus.2&quot;</span>,<span class="st">&quot;school_clus.4&quot;</span>)]&lt;-<span class="dv">0</span> </a>
<a class="sourceLine" id="cb13-25" title="25">pred[<span class="kw">c</span>(<span class="st">&quot;prev_dep.4&quot;</span>,<span class="st">&quot;t_score.4&quot;</span>,<span class="st">&quot;prev_sdq.4&quot;</span>),<span class="kw">c</span>(<span class="st">&quot;school_clus.W1&quot;</span>,<span class="st">&quot;school_clus.2&quot;</span>,<span class="st">&quot;school_clus.3&quot;</span>)]&lt;-<span class="dv">0</span> </a>
<a class="sourceLine" id="cb13-26" title="26">pred[<span class="st">&quot;tscore_W1&quot;</span>,<span class="kw">c</span>(<span class="st">&quot;school_clus.2&quot;</span>,<span class="st">&quot;school_clus.3&quot;</span>,<span class="st">&quot;school_clus.4&quot;</span>)]&lt;-<span class="dv">0</span> </a>
<a class="sourceLine" id="cb13-27" title="27"></a>
<a class="sourceLine" id="cb13-28" title="28"><span class="co">##Perform imputations</span></a>
<a class="sourceLine" id="cb13-29" title="29">imp5=<span class="kw">mice</span>(<span class="dt">data=</span>CATS_dataFCSv, <span class="dt">predictorMatrix =</span> pred,<span class="dt">m=</span>M,<span class="dt">method=</span><span class="st">&quot;norm&quot;</span>,<span class="dt">maxit=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb13-30" title="30"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb13-31" title="31"><span class="co">#&gt;  iter imp variable</span></a>
<a class="sourceLine" id="cb13-32" title="32"><span class="co">#&gt;   1   1  tscore_W1  t_score.2  prev_sdq.2  prev_dep.2  t_score.3  prev_sdq.3  prev_dep.3  t_score.4  prev_sdq.4  prev_dep.4</span></a>
<a class="sourceLine" id="cb13-33" title="33"><span class="co">#&gt;   1   2  tscore_W1  t_score.2  prev_sdq.2  prev_dep.2  t_score.3  prev_sdq.3  prev_dep.3  t_score.4  prev_sdq.4  prev_dep.4</span></a>
<a class="sourceLine" id="cb13-34" title="34"><span class="co">#&gt;   1   3  tscore_W1  t_score.2  prev_sdq.2  prev_dep.2  t_score.3  prev_sdq.3  prev_dep.3  t_score.4  prev_sdq.4  prev_dep.4</span></a>
<a class="sourceLine" id="cb13-35" title="35"><span class="co">#&gt; Warning: Number of logged events: 27</span></a></code></pre></div>
<p>Post-imputation, the imputed datasets will need to be reshaped into long format before fitting the substantive analysis model as before.</p>
</div>
<div id="two-level-fcs-for-the-higher-level-clusters-with-repeated-measures-imputed-in-wide-format-fcs-2l-wide" class="section level3">
<h3>9. Two-level FCS for the higher-level clusters with repeated measures imputed in wide format (FCS-2L-wide)</h3>
<p>Underthis approach, the data will be in wide format during the imputation stage. Two-level univariate linear imputation models are specified for each incomplete variable. To specify the imputation models, the method <code>2l.pan</code> in the R package <code>mice</code> can be used. Here for each univariate imputation model as before an predictor variables to be used will need to be specified. In addition, in each model, the school cluster membership will too need to be included as the cluster/group variable. This cam be done by using the integer value (-2) in the predictor matrix specification, indicating the cluster variable is to be modelled via random effects.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="co">##set the number of imputations</span></a>
<a class="sourceLine" id="cb14-3" title="3">M=<span class="dv">3</span>   <span class="co">#set to 3 to reduce the time of demo, 20 more appropriate</span></a>
<a class="sourceLine" id="cb14-4" title="4"></a>
<a class="sourceLine" id="cb14-5" title="5"></a>
<a class="sourceLine" id="cb14-6" title="6"><span class="co">#create the predictor matrix</span></a>
<a class="sourceLine" id="cb14-7" title="7">pred=<span class="kw">make.predictorMatrix</span>(CATS_dataw)</a>
<a class="sourceLine" id="cb14-8" title="8"></a>
<a class="sourceLine" id="cb14-9" title="9"><span class="co">#In the predictor matrix, a value of</span></a>
<a class="sourceLine" id="cb14-10" title="10"><span class="co">#0: Indicates that the column variable is not used as predictor for the row variable</span></a>
<a class="sourceLine" id="cb14-11" title="11"><span class="co">#1: Indicates that the column variable is used as a predcitor with a fixed effect for the row variable</span></a>
<a class="sourceLine" id="cb14-12" title="12"><span class="co">#2:  Indicates that the column variable is used as a predcitor with a fixed and a random effect for the row variable</span></a>
<a class="sourceLine" id="cb14-13" title="13"><span class="co">#-2:  Indicates that column variable is the cluster/group variable (Only one variable is allowed)- needs to be coded as integer</span></a>
<a class="sourceLine" id="cb14-14" title="14"></a>
<a class="sourceLine" id="cb14-15" title="15"><span class="co">##Recode school cluster at wave 2 back to an integer variable-as it was convereted to a factor in (3) above</span></a>
<a class="sourceLine" id="cb14-16" title="16">CATS_dataw<span class="op">$</span>school_clus<span class="fl">.2</span>=<span class="kw">as.integer</span>(CATS_dataw<span class="op">$</span>school_clus<span class="fl">.2</span>)</a>
<a class="sourceLine" id="cb14-17" title="17"></a>
<a class="sourceLine" id="cb14-18" title="18"></a>
<a class="sourceLine" id="cb14-19" title="19"><span class="co">#Remove variables that are not required to be imputed and other unwanted predictor variables from the predictor matrix </span></a>
<a class="sourceLine" id="cb14-20" title="20">pred[<span class="kw">c</span>(<span class="st">&quot;uniqueid&quot;</span>,<span class="st">&quot;cdgender&quot;</span>,<span class="st">&quot;c1dage&quot;</span>,<span class="st">&quot;school_clus.W1&quot;</span>,<span class="st">&quot;school_clus.2&quot;</span>,<span class="st">&quot;school_clus.3&quot;</span>,<span class="st">&quot;school_clus.4&quot;</span>,<span class="st">&quot;SES&quot;</span>),]&lt;-<span class="dv">0</span></a>
<a class="sourceLine" id="cb14-21" title="21">pred[,<span class="st">&quot;uniqueid&quot;</span>]=<span class="dv">0</span></a>
<a class="sourceLine" id="cb14-22" title="22">pred[<span class="kw">c</span>(<span class="st">&quot;prev_dep.2&quot;</span>,<span class="st">&quot;t_score.2&quot;</span>,<span class="st">&quot;prev_sdq.2&quot;</span>),<span class="kw">c</span>(<span class="st">&quot;school_clus.3&quot;</span>,<span class="st">&quot;school_clus.4&quot;</span>)]&lt;-<span class="dv">0</span></a>
<a class="sourceLine" id="cb14-23" title="23">pred[<span class="kw">c</span>(<span class="st">&quot;prev_dep.3&quot;</span>,<span class="st">&quot;t_score.3&quot;</span>,<span class="st">&quot;prev_sdq.3&quot;</span>),<span class="kw">c</span>(<span class="st">&quot;school_clus.2&quot;</span>,<span class="st">&quot;school_clus.4&quot;</span>)]&lt;-<span class="dv">0</span></a>
<a class="sourceLine" id="cb14-24" title="24">pred[<span class="kw">c</span>(<span class="st">&quot;prev_dep.4&quot;</span>,<span class="st">&quot;t_score.4&quot;</span>,<span class="st">&quot;prev_sdq.4&quot;</span>),<span class="kw">c</span>(<span class="st">&quot;school_clus.2&quot;</span>,<span class="st">&quot;school_clus.3&quot;</span>)]&lt;-<span class="dv">0</span></a>
<a class="sourceLine" id="cb14-25" title="25">pred[<span class="st">&quot;tscore_W1&quot;</span>,<span class="kw">c</span>(<span class="st">&quot;school_clus.2&quot;</span>,<span class="st">&quot;school_clus.3&quot;</span>,<span class="st">&quot;school_clus.4&quot;</span>)]&lt;-<span class="dv">0</span></a>
<a class="sourceLine" id="cb14-26" title="26"></a>
<a class="sourceLine" id="cb14-27" title="27"><span class="co">#specify the cluster variables for each incomplete variable</span></a>
<a class="sourceLine" id="cb14-28" title="28">pred[<span class="kw">c</span>(<span class="st">&quot;prev_dep.2&quot;</span>,<span class="st">&quot;t_score.2&quot;</span>,<span class="st">&quot;prev_sdq.2&quot;</span>),<span class="st">&quot;school_clus.2&quot;</span>]=<span class="op">-</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb14-29" title="29">pred[<span class="kw">c</span>(<span class="st">&quot;prev_dep.3&quot;</span>,<span class="st">&quot;t_score.3&quot;</span>,<span class="st">&quot;prev_sdq.3&quot;</span>),<span class="st">&quot;school_clus.3&quot;</span>]=<span class="op">-</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb14-30" title="30">pred[<span class="kw">c</span>(<span class="st">&quot;prev_dep.4&quot;</span>,<span class="st">&quot;t_score.4&quot;</span>,<span class="st">&quot;prev_sdq.4&quot;</span>),<span class="st">&quot;school_clus.4&quot;</span>]=<span class="op">-</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb14-31" title="31">pred[<span class="st">&quot;tscore_W1&quot;</span>,<span class="st">&quot;school_clus.W1&quot;</span>]&lt;-<span class="op">-</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb14-32" title="32"></a>
<a class="sourceLine" id="cb14-33" title="33"><span class="co">#Perform the imputations</span></a>
<a class="sourceLine" id="cb14-34" title="34">imp6&lt;-<span class="kw">mice</span>(CATS_dataw,<span class="dt">m=</span>M, <span class="dt">maxit=</span><span class="dv">1</span>,<span class="dt">predictorMatrix=</span>pred, <span class="dt">method=</span><span class="st">&quot;2l.pan&quot;</span>)</a>
<a class="sourceLine" id="cb14-35" title="35"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb14-36" title="36"><span class="co">#&gt;  iter imp variable</span></a>
<a class="sourceLine" id="cb14-37" title="37"><span class="co">#&gt;   1   1  tscore_W1  t_score.2  prev_sdq.2  prev_dep.2  t_score.3  prev_sdq.3  prev_dep.3  t_score.4  prev_sdq.4  prev_dep.4</span></a>
<a class="sourceLine" id="cb14-38" title="38"><span class="co">#&gt;   1   2  tscore_W1  t_score.2  prev_sdq.2  prev_dep.2  t_score.3  prev_sdq.3  prev_dep.3  t_score.4  prev_sdq.4  prev_dep.4</span></a>
<a class="sourceLine" id="cb14-39" title="39"><span class="co">#&gt;   1   3  tscore_W1  t_score.2  prev_sdq.2  prev_dep.2  t_score.3  prev_sdq.3  prev_dep.3  t_score.4  prev_sdq.4  prev_dep.4</span></a></code></pre></div>
<p>Post-imputation, the imputed datasets will need to be reshaped into long format before fitting the substantive analysis model.</p>
</div>
<div id="two-level-jm-for-repeated-measures-with-di-for-higher-level-clusters-jm-2l-di" class="section level3">
<h3>10. Two-level JM for repeated measures with DI for higher-level clusters (JM-2L-DI)</h3>
<p>Under this approach, the data can be imputed in long format because the clustering between repeated measures of the same variable is now modelled using the two-level joint imputation model in <code>jomo</code>. The incomplete variables will be specified as outcomes(Y) in the two level imputation model, while all complete variables will serve as the predictors(X) as before. However, here we also have to define incomplete level-2 variables as well.As before to include fully observed categorical covariates with three or more categories in the predictor matrix of the imputation model, appropriate dummy variables have to be created. An additional data frame (Z) will also need to be created for the random intercepts for each individual and the cluster indicator, individual’s uniqueid, will need to be specified in the imputation model as shown below.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1"><span class="co">##Set number of imputations </span></a>
<a class="sourceLine" id="cb15-2" title="2">M=<span class="dv">3</span>     <span class="co">#set to 3 to reduce the time of demo, set to 20 </span></a>
<a class="sourceLine" id="cb15-3" title="3">nburn=<span class="dv">1</span> <span class="co">#set to 1 to reduce the time of demo, set to 1000 </span></a>
<a class="sourceLine" id="cb15-4" title="4">NB=<span class="dv">1</span>      <span class="co">#set to 1 to reduce the time of demo, set to 100 </span></a>
<a class="sourceLine" id="cb15-5" title="5"></a>
<a class="sourceLine" id="cb15-6" title="6"><span class="co">##Create a dataframe with variables to be imputed</span></a>
<a class="sourceLine" id="cb15-7" title="7"></a>
<a class="sourceLine" id="cb15-8" title="8"><span class="co">#For level 1 variables</span></a>
<a class="sourceLine" id="cb15-9" title="9">myvars1 &lt;-<span class="st"> </span><span class="kw">names</span>(CATS_dataL) <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;prev_dep&quot;</span>,<span class="st">&quot;prev_sdq&quot;</span>,<span class="st">&quot;t_score&quot;</span>) </a>
<a class="sourceLine" id="cb15-10" title="10">dataimp1=CATS_dataL[myvars1]</a>
<a class="sourceLine" id="cb15-11" title="11"></a>
<a class="sourceLine" id="cb15-12" title="12"><span class="co">#For level 2 variables</span></a>
<a class="sourceLine" id="cb15-13" title="13">myvars2 &lt;-<span class="st"> </span><span class="kw">names</span>(CATS_dataL) <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;tscore_W1&quot;</span>) </a>
<a class="sourceLine" id="cb15-14" title="14">dataimp2=CATS_dataL[myvars2]</a>
<a class="sourceLine" id="cb15-15" title="15"></a>
<a class="sourceLine" id="cb15-16" title="16"><span class="co">##Create a dataframe with complete variables for imputing level 1 varriables</span></a>
<a class="sourceLine" id="cb15-17" title="17">datacomp1=<span class="kw">cbind</span>(<span class="dt">Intercept=</span><span class="kw">rep</span>(<span class="dv">1</span>,<span class="kw">nrow</span>(CATS_dataL)),CATS_dataL[,<span class="kw">names</span>(CATS_dataL)<span class="op">%in%</span><span class="kw">c</span>(<span class="st">&quot;SES&quot;</span>,<span class="st">&quot;c1dage&quot;</span>,<span class="st">&quot;cdgender&quot;</span>,<span class="st">&quot;time&quot;</span>,<span class="st">&quot;school_clus&quot;</span>)])</a>
<a class="sourceLine" id="cb15-18" title="18"></a>
<a class="sourceLine" id="cb15-19" title="19"><span class="co">#Create a dataframe with complete variables for imputing level 2 variables</span></a>
<a class="sourceLine" id="cb15-20" title="20">datacomp2=<span class="kw">cbind</span>(<span class="dt">Intercept=</span><span class="kw">rep</span>(<span class="dv">1</span>,<span class="kw">nrow</span>(CATS_dataL)),CATS_dataL[,<span class="kw">names</span>(CATS_dataL)<span class="op">%in%</span><span class="kw">c</span>(<span class="st">&quot;SES&quot;</span>,<span class="st">&quot;c1dage&quot;</span>,<span class="st">&quot;cdgender&quot;</span>)])</a>
<a class="sourceLine" id="cb15-21" title="21"></a>
<a class="sourceLine" id="cb15-22" title="22"><span class="co">##create school dummy indicators for waves, 2,3 and 4</span></a>
<a class="sourceLine" id="cb15-23" title="23">datacomp_dummy=fastDummies<span class="op">::</span><span class="kw">dummy_cols</span>(datacomp1, <span class="dt">select_columns =</span><span class="kw">c</span>(<span class="st">&quot;school_clus&quot;</span>),<span class="dt">remove_first_dummy =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb15-24" title="24"></a>
<a class="sourceLine" id="cb15-25" title="25"><span class="co">#Remove school cluster indicator </span></a>
<a class="sourceLine" id="cb15-26" title="26">datacomp_dummy &lt;-<span class="st"> </span>datacomp_dummy <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">!</span>school_clus)</a>
<a class="sourceLine" id="cb15-27" title="27"></a>
<a class="sourceLine" id="cb15-28" title="28"><span class="co">#Create a data frame with complete variables with RANDOM EFFECTS, with column of 1&#39;s for intercept</span></a>
<a class="sourceLine" id="cb15-29" title="29">datLcompRE&lt;-<span class="kw">cbind</span>(<span class="dt">Intercept=</span><span class="kw">rep</span>(<span class="dv">1</span>,<span class="kw">nrow</span>(CATS_dataL)))</a>
<a class="sourceLine" id="cb15-30" title="30"></a>
<a class="sourceLine" id="cb15-31" title="31"><span class="co">##Perform imputations with the random effects (2L imputation)</span></a>
<a class="sourceLine" id="cb15-32" title="32">imp7&lt;-<span class="kw">jomo</span>(<span class="dt">Y=</span>dataimp1,<span class="dt">Y2=</span>dataimp2,<span class="dt">X=</span>datacomp_dummy,<span class="dt">X2=</span>datacomp2,<span class="dt">Z=</span>datLcompRE,<span class="dt">clus=</span>CATS_dataL<span class="op">$</span>uniqueid,<span class="dt">nimp=</span>M,<span class="dt">nburn=</span>nburn,<span class="dt">nbetween=</span>NB)</a>
<a class="sourceLine" id="cb15-33" title="33"><span class="co">#output not shown  to reduce length of vignette</span></a></code></pre></div>
<p>Post-imputation, no reshape is required as the data was imputed in long format. However, the original school cluster variable will be need to be reattached as it was replaced by dummy inidcators in the imputation stage.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">mylist=<span class="kw">list</span>()</a>
<a class="sourceLine" id="cb16-2" title="2"></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="cf">for</span>(m <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>M)</a>
<a class="sourceLine" id="cb16-4" title="4">{</a>
<a class="sourceLine" id="cb16-5" title="5">  <span class="co">#1. Extract the mth imputed variable </span></a>
<a class="sourceLine" id="cb16-6" title="6">   datL&lt;-imp7[imp7<span class="op">$</span>Imputation<span class="op">==</span>m,]</a>
<a class="sourceLine" id="cb16-7" title="7">  </a>
<a class="sourceLine" id="cb16-8" title="8">  <span class="co">#2. Attach the original school variables</span></a>
<a class="sourceLine" id="cb16-9" title="9">  datL=<span class="kw">cbind</span>(datL,CATS_dataL<span class="op">$</span>school_clus)</a>
<a class="sourceLine" id="cb16-10" title="10"> </a>
<a class="sourceLine" id="cb16-11" title="11">  <span class="co">#3. Remove unwanted variables</span></a>
<a class="sourceLine" id="cb16-12" title="12">  datL &lt;-<span class="st"> </span>datL[<span class="op">!</span><span class="kw">duplicated</span>(<span class="kw">as.list</span>(datL))]</a>
<a class="sourceLine" id="cb16-13" title="13">  datL=datL <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">!</span><span class="kw">contains</span>(<span class="kw">c</span>(<span class="st">&quot;school_clus_&quot;</span>,<span class="st">&quot;prev_sdq&quot;</span>)),<span class="op">-</span>Intercept,<span class="op">-</span>id)</a>
<a class="sourceLine" id="cb16-14" title="14">  datL=datL <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">school=</span><span class="st">`</span><span class="dt">CATS_dataL$school_clus</span><span class="st">`</span>)</a>
<a class="sourceLine" id="cb16-15" title="15">  </a>
<a class="sourceLine" id="cb16-16" title="16">  <span class="co">#4. save the dataset in a list</span></a>
<a class="sourceLine" id="cb16-17" title="17">  mylist[[m]]=<span class="st"> </span>datL</a>
<a class="sourceLine" id="cb16-18" title="18">}</a>
<a class="sourceLine" id="cb16-19" title="19"></a>
<a class="sourceLine" id="cb16-20" title="20"><span class="co">#Fit the analysis of interest on the imputed datasets </span></a>
<a class="sourceLine" id="cb16-21" title="21">mods &lt;-<span class="st"> </span><span class="kw">lapply</span>(mylist,<span class="cf">function</span>(d) {<span class="kw">lmer</span>(t_score<span class="op">~</span><span class="st"> </span>prev_dep<span class="op">+</span>time<span class="op">+</span>c1dage<span class="op">+</span>tscore_W1<span class="op">+</span>cdgender<span class="op">+</span>SES<span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>clus)<span class="op">+</span>(<span class="dv">1</span><span class="op">|</span>school), <span class="dt">data=</span>d) } )</a>
<a class="sourceLine" id="cb16-22" title="22"></a>
<a class="sourceLine" id="cb16-23" title="23"><span class="kw">testEstimates</span>(mods, <span class="dt">var.comp=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb16-24" title="24"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-25" title="25"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb16-26" title="26"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-27" title="27"><span class="co">#&gt; testEstimates(model = mods, var.comp = TRUE)</span></a>
<a class="sourceLine" id="cb16-28" title="28"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-29" title="29"><span class="co">#&gt; Final parameter estimates and inferences obtained from 3 imputed data sets.</span></a>
<a class="sourceLine" id="cb16-30" title="30"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-31" title="31"><span class="co">#&gt;              Estimate Std.Error   t.value        df   P(&gt;|t|)       RIV       FMI </span></a>
<a class="sourceLine" id="cb16-32" title="32"><span class="co">#&gt; (Intercept)     2.619     0.288     9.088    22.387     0.000     0.426     0.354 </span></a>
<a class="sourceLine" id="cb16-33" title="33"><span class="co">#&gt; prev_dep       -0.040     0.011    -3.736    33.066     0.001     0.326     0.288 </span></a>
<a class="sourceLine" id="cb16-34" title="34"><span class="co">#&gt; time            0.030     0.016     1.815   121.513     0.072     0.147     0.142 </span></a>
<a class="sourceLine" id="cb16-35" title="35"><span class="co">#&gt; c1dage         -0.180     0.027    -6.559    50.376     0.000     0.249     0.229 </span></a>
<a class="sourceLine" id="cb16-36" title="36"><span class="co">#&gt; tscore_W1       0.650     0.027    23.891    12.949     0.000     0.647     0.469 </span></a>
<a class="sourceLine" id="cb16-37" title="37"><span class="co">#&gt; cdgender        0.052     0.044     1.176  2111.085     0.240     0.032     0.032 </span></a>
<a class="sourceLine" id="cb16-38" title="38"><span class="co">#&gt; SES            -0.003     0.024    -0.128    58.848     0.899     0.226     0.211 </span></a>
<a class="sourceLine" id="cb16-39" title="39"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-40" title="40"><span class="co">#&gt;                             Estimate </span></a>
<a class="sourceLine" id="cb16-41" title="41"><span class="co">#&gt; Intercept~~Intercept|clus      0.361 </span></a>
<a class="sourceLine" id="cb16-42" title="42"><span class="co">#&gt; Intercept~~Intercept|school    0.241 </span></a>
<a class="sourceLine" id="cb16-43" title="43"><span class="co">#&gt; Residual~~Residual             0.527 </span></a>
<a class="sourceLine" id="cb16-44" title="44"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-45" title="45"><span class="co">#&gt; Unadjusted hypothesis test as appropriate in larger samples.</span></a></code></pre></div>
</div>
<div id="two-level-fcs-for-repeated-measures-with-di-for-higher-level-clusters-fcs-2l-di" class="section level3">
<h3>11. Two-level FCS for repeated measures with DI for higher-level clusters (FCS-2L-DI)</h3>
<p>Similar to <strong><em>JM-2L-DI</em></strong> here the repeated measures will be imputed in long format, with the clustering between repeated measures of the same variable modelled using a univariate two-level imputation model. The imputation models can be specified using the R package `mice’.</p>
<p>For each univariate imputation model, an imputation method and the predictor variables to be used will need to be specified as shown below. When specifying the predictor matrix, specify the id variable <code>uniquieid</code> as the group variable (-2) , remove school cluster membership at wave 1 from the predicor set for all variables and finally, remove the time-varying school cluster membership from the imputation model of the time-fixed baseline variable <code>tscore_W1</code>. The latter is because the imputation method used for imputing level-2 variable, <code>2lonly.norm</code>, averages all level 1 predictor to impute the level -2 variable by using a linear model. Aggregrating school cluster inidcators this way is not practical and it results in implausible imputed values.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="co"># Recode the cluster variable from factor to integer</span></a>
<a class="sourceLine" id="cb17-3" title="3">CATS_dataL<span class="op">$</span>uniqueid &lt;-<span class="st"> </span><span class="kw">as.integer</span>(CATS_dataL<span class="op">$</span>uniqueid)</a>
<a class="sourceLine" id="cb17-4" title="4"></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="co">##set the number of imputations </span></a>
<a class="sourceLine" id="cb17-6" title="6">M=<span class="dv">3</span> <span class="co">#set to 3 to reduce the time of demo, 20 more appropriate</span></a>
<a class="sourceLine" id="cb17-7" title="7"></a>
<a class="sourceLine" id="cb17-8" title="8"><span class="co">#Recode all cluster indicator variables to factor</span></a>
<a class="sourceLine" id="cb17-9" title="9">CATS_dataL[,<span class="kw">c</span>(<span class="st">&quot;school_clus&quot;</span>,<span class="st">&quot;school_clus.W1&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">lapply</span>(CATS_dataL[,<span class="kw">c</span>(<span class="st">&quot;school_clus&quot;</span>,<span class="st">&quot;school_clus.W1&quot;</span>)],factor)</a>
<a class="sourceLine" id="cb17-10" title="10"></a>
<a class="sourceLine" id="cb17-11" title="11"><span class="co">#Create the predictor matrix</span></a>
<a class="sourceLine" id="cb17-12" title="12">pred=<span class="kw">make.predictorMatrix</span>(CATS_dataL)</a>
<a class="sourceLine" id="cb17-13" title="13"></a>
<a class="sourceLine" id="cb17-14" title="14"><span class="co">#In the predictor matrix, a value of</span></a>
<a class="sourceLine" id="cb17-15" title="15"><span class="co">#0: Indicates that the column variable is not used as predictor for the row variable</span></a>
<a class="sourceLine" id="cb17-16" title="16"><span class="co">#1: Indicates that the column variable is used as a predcitor with a fixed effect for the row variable</span></a>
<a class="sourceLine" id="cb17-17" title="17"><span class="co">#2:  Indicates that the column variable is used as a predcitor with a fixed and a random effect for the row variable</span></a>
<a class="sourceLine" id="cb17-18" title="18"><span class="co">#-2:  Indicates that column variable is the cluster/group variable (Only one variable is allowed)</span></a>
<a class="sourceLine" id="cb17-19" title="19"></a>
<a class="sourceLine" id="cb17-20" title="20"></a>
<a class="sourceLine" id="cb17-21" title="21">pred[,<span class="st">&quot;uniqueid&quot;</span>]=<span class="op">-</span><span class="dv">2</span> <span class="co"># ID variable to be used as the cluster variable</span></a>
<a class="sourceLine" id="cb17-22" title="22">pred[<span class="kw">c</span>(<span class="st">&quot;uniqueid&quot;</span>,<span class="st">&quot;cdgender&quot;</span>,<span class="st">&quot;c1dage&quot;</span>,<span class="st">&quot;time&quot;</span>,<span class="st">&quot;SES&quot;</span>,<span class="st">&quot;school_clus&quot;</span>,<span class="st">&quot;school_clus.W1&quot;</span>),]&lt;-<span class="dv">0</span><span class="co">#Set fully observed variables to 0 as they don&#39;t need to be imputed</span></a>
<a class="sourceLine" id="cb17-23" title="23">pred[<span class="st">&quot;tscore_W1&quot;</span>,<span class="st">&quot;school_clus&quot;</span>]&lt;-<span class="dv">0</span>    <span class="co">#Remove the school cluster variable from the imputation model for                                                #time-fixed variable (This is because aggregrating them to the                                                #individual level</span></a>
<a class="sourceLine" id="cb17-24" title="24">pred[<span class="kw">c</span>(<span class="st">&quot;prev_dep&quot;</span>,<span class="st">&quot;prev_sdq&quot;</span>,<span class="st">&quot;t_score&quot;</span>),<span class="st">&quot;school_clus.W1&quot;</span>] &lt;-<span class="st"> </span><span class="dv">0</span> <span class="co">#Remove school cluster inidcator at wave 1 from the                                                          #imputation models of time-varying variables</span></a>
<a class="sourceLine" id="cb17-25" title="25"></a>
<a class="sourceLine" id="cb17-26" title="26"><span class="co">##Specify the imputation method</span></a>
<a class="sourceLine" id="cb17-27" title="27">meth=<span class="kw">make.method</span>(CATS_dataL)</a>
<a class="sourceLine" id="cb17-28" title="28">meth[<span class="kw">c</span>( <span class="st">&quot;t_score&quot;</span>,<span class="st">&quot;prev_sdq&quot;</span> ,<span class="st">&quot;prev_dep&quot;</span>)]=<span class="st">&quot;2l.pan&quot;</span></a>
<a class="sourceLine" id="cb17-29" title="29"><span class="co">#meth[&quot;tscore_W1&quot;]=&quot;2lonly.norm&quot;  #Here level 2 variable not imputed due to sparseness in simulated data, in practice this needs to be imputed using a method for imputing level 2 variables</span></a>
<a class="sourceLine" id="cb17-30" title="30"></a>
<a class="sourceLine" id="cb17-31" title="31"><span class="co">#Perform the imputations</span></a>
<a class="sourceLine" id="cb17-32" title="32">imp8&lt;-<span class="kw">mice</span>(CATS_dataL,<span class="dt">m=</span>M, <span class="dt">maxit=</span><span class="dv">1</span>,<span class="dt">predictorMatrix=</span>pred, <span class="dt">method=</span>meth)</a>
<a class="sourceLine" id="cb17-33" title="33"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb17-34" title="34"><span class="co">#&gt;  iter imp variable</span></a>
<a class="sourceLine" id="cb17-35" title="35"><span class="co">#&gt;   1   1  tscore_W1  prev_dep  t_score  prev_sdq</span></a>
<a class="sourceLine" id="cb17-36" title="36"><span class="co">#&gt;   1   2  tscore_W1  prev_dep  t_score  prev_sdq</span></a>
<a class="sourceLine" id="cb17-37" title="37"><span class="co">#&gt;   1   3  tscore_W1  prev_dep  t_score  prev_sdq</span></a>
<a class="sourceLine" id="cb17-38" title="38"><span class="co">#&gt; Warning: Number of logged events: 12</span></a></code></pre></div>
<p>Post-imputation, no reshape is required as the data was imputed in long format and the anlysis can be carried out on the imputed data.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">mylist=<span class="kw">list</span>()</a>
<a class="sourceLine" id="cb18-2" title="2"></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="cf">for</span>(m <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>M)</a>
<a class="sourceLine" id="cb18-4" title="4">{</a>
<a class="sourceLine" id="cb18-5" title="5">  datL&lt;-mice<span class="op">::</span><span class="kw">complete</span>(imp8,m)</a>
<a class="sourceLine" id="cb18-6" title="6">  </a>
<a class="sourceLine" id="cb18-7" title="7">  <span class="co">#5. save the dataset in a list</span></a>
<a class="sourceLine" id="cb18-8" title="8">  mylist[[m]]=<span class="st"> </span>datL</a>
<a class="sourceLine" id="cb18-9" title="9">}</a>
<a class="sourceLine" id="cb18-10" title="10"></a>
<a class="sourceLine" id="cb18-11" title="11"><span class="co">#Fit the analysis of interest on the imputed datasets </span></a>
<a class="sourceLine" id="cb18-12" title="12">mods &lt;-<span class="st"> </span><span class="kw">lapply</span>(mylist,<span class="cf">function</span>(d) {<span class="kw">lmer</span>(t_score<span class="op">~</span><span class="st"> </span>prev_dep<span class="op">+</span>time<span class="op">+</span>c1dage<span class="op">+</span>tscore_W1<span class="op">+</span>cdgender<span class="op">+</span>SES<span class="op">+</span></a>
<a class="sourceLine" id="cb18-13" title="13"><span class="st">                                          </span>(<span class="dv">1</span><span class="op">|</span>uniqueid)<span class="op">+</span>(<span class="dv">1</span><span class="op">|</span>school_clus), <span class="dt">data=</span>d) } )</a>
<a class="sourceLine" id="cb18-14" title="14"><span class="kw">testEstimates</span>(mods, <span class="dt">var.comp=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb18-15" title="15"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb18-16" title="16"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb18-17" title="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb18-18" title="18"><span class="co">#&gt; testEstimates(model = mods, var.comp = TRUE)</span></a>
<a class="sourceLine" id="cb18-19" title="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb18-20" title="20"><span class="co">#&gt; Final parameter estimates and inferences obtained from 3 imputed data sets.</span></a>
<a class="sourceLine" id="cb18-21" title="21"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb18-22" title="22"><span class="co">#&gt;              Estimate Std.Error   t.value        df   P(&gt;|t|)       RIV       FMI </span></a>
<a class="sourceLine" id="cb18-23" title="23"><span class="co">#&gt; (Intercept)     2.701     0.265    10.200    48.569     0.000     0.255     0.234 </span></a>
<a class="sourceLine" id="cb18-24" title="24"><span class="co">#&gt; prev_dep       -0.037     0.010    -3.816   105.051     0.000     0.160     0.154 </span></a>
<a class="sourceLine" id="cb18-25" title="25"><span class="co">#&gt; time            0.043     0.018     2.354    18.941     0.029     0.481     0.386 </span></a>
<a class="sourceLine" id="cb18-26" title="26"><span class="co">#&gt; c1dage         -0.189     0.028    -6.718    31.497     0.000     0.337     0.295 </span></a>
<a class="sourceLine" id="cb18-27" title="27"><span class="co">#&gt; tscore_W1       0.637     0.021    30.906   298.345     0.000     0.089     0.088 </span></a>
<a class="sourceLine" id="cb18-28" title="28"><span class="co">#&gt; cdgender        0.069     0.048     1.444    60.942     0.154     0.221     0.207 </span></a>
<a class="sourceLine" id="cb18-29" title="29"><span class="co">#&gt; SES             0.007     0.023     0.316   134.133     0.753     0.139     0.135 </span></a>
<a class="sourceLine" id="cb18-30" title="30"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb18-31" title="31"><span class="co">#&gt;                                  Estimate </span></a>
<a class="sourceLine" id="cb18-32" title="32"><span class="co">#&gt; Intercept~~Intercept|uniqueid       0.365 </span></a>
<a class="sourceLine" id="cb18-33" title="33"><span class="co">#&gt; Intercept~~Intercept|school_clus    0.188 </span></a>
<a class="sourceLine" id="cb18-34" title="34"><span class="co">#&gt; Residual~~Residual                  0.496 </span></a>
<a class="sourceLine" id="cb18-35" title="35"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb18-36" title="36"><span class="co">#&gt; Unadjusted hypothesis test as appropriate in larger samples.</span></a></code></pre></div>
</div>
<div id="three-level-fcs-fcs-3l-ml.lmer" class="section level3">
<h3>12. Three-level FCS (FCS-3L-ml.lmer)</h3>
<p>Under this approach a univariate CCREM is specified for each incomplete variable. The imputation method <code>ml.lmer</code> from the R package `miceadds’ can be used for this As a three-level model is used, the repeated measures will be imputed in long format. As in the previous FCS approaches, a predictor matrix and an imputation method will need to be specified for each incomplete variable.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1"><span class="co"># create default predictor matrix and imputation methods</span></a>
<a class="sourceLine" id="cb19-2" title="2">predMatrix &lt;-<span class="st"> </span><span class="kw">make.predictorMatrix</span>(<span class="dt">data =</span> CATS_dataL)</a>
<a class="sourceLine" id="cb19-3" title="3">impMethod &lt;-<span class="st"> </span><span class="kw">make.method</span>(<span class="dt">data =</span> CATS_dataL)</a>
<a class="sourceLine" id="cb19-4" title="4"></a>
<a class="sourceLine" id="cb19-5" title="5"></a>
<a class="sourceLine" id="cb19-6" title="6"><span class="co"># method for lower-level variables :tscore_W1 at level 2, and t_score,c_sdq and prev_sdq at level 1</span></a>
<a class="sourceLine" id="cb19-7" title="7">impMethod[<span class="st">&quot;tscore_W1&quot;</span>] &lt;-<span class="st"> &quot;ml.lmer&quot;</span></a>
<a class="sourceLine" id="cb19-8" title="8">impMethod[<span class="st">&quot;t_score&quot;</span>] &lt;-<span class="st"> &quot;ml.lmer&quot;</span></a>
<a class="sourceLine" id="cb19-9" title="9">impMethod[<span class="st">&quot;prev_sdq&quot;</span>] &lt;-<span class="st"> &quot;ml.lmer&quot;</span></a>
<a class="sourceLine" id="cb19-10" title="10">impMethod[<span class="st">&quot;prev_dep&quot;</span>] &lt;-<span class="st"> &quot;ml.lmer&quot;</span></a>
<a class="sourceLine" id="cb19-11" title="11"></a>
<a class="sourceLine" id="cb19-12" title="12"><span class="co"># remove cluster indicator variables from set of predictors</span></a>
<a class="sourceLine" id="cb19-13" title="13">predMatrix[, <span class="kw">c</span>(<span class="st">&quot;uniqueid&quot;</span>, <span class="st">&quot;school_clus&quot;</span>)] &lt;-<span class="st"> </span><span class="dv">0</span></a></code></pre></div>
<p>In addition to the predictor matrix, for variables that will be imputed using the method ml.lmer, the hierarchical structure must be set with two additional arguments (i.e. outside the predictor matrix). For all higher-level variables (i.e. those at level 2 and level 3) we need to specify the level at which the variables are measured. For rest of the variables (i.e. for level 1 variables) the level can be left blank.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1"></a>
<a class="sourceLine" id="cb20-2" title="2"><span class="co"># specify levels of higher-level variables </span></a>
<a class="sourceLine" id="cb20-3" title="3">level &lt;-<span class="st"> </span><span class="kw">character</span>(<span class="kw">ncol</span>(CATS_dataL))</a>
<a class="sourceLine" id="cb20-4" title="4"><span class="kw">names</span>(level) &lt;-<span class="st"> </span><span class="kw">colnames</span>(CATS_dataL)</a>
<a class="sourceLine" id="cb20-5" title="5">level[<span class="st">&quot;cdgender&quot;</span>] &lt;-<span class="st"> &quot;uniqueid&quot;</span>    <span class="co">#for sex</span></a>
<a class="sourceLine" id="cb20-6" title="6">level[<span class="st">&quot;c1dage&quot;</span>] &lt;-<span class="st"> &quot;uniqueid&quot;</span>      <span class="co">#for age</span></a>
<a class="sourceLine" id="cb20-7" title="7">level[<span class="st">&quot;tscore_w1&quot;</span>] &lt;-<span class="st"> &quot;uniqueid&quot;</span>    <span class="co">#for teacher rating at wave 1</span></a>
<a class="sourceLine" id="cb20-8" title="8">level[<span class="st">&quot;SES&quot;</span>] &lt;-<span class="st"> &quot;uniqueid&quot;</span>         <span class="co"># for SES</span></a></code></pre></div>
<p>Next for each variable being imputed, cluster variables that define the hierarchical structure in the imputation model must be specified as follows. By default, this uses a random intercept model with random effects at each of the specified levels.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1"><span class="co"># specify cluster indicators (as list)</span></a>
<a class="sourceLine" id="cb21-2" title="2">cluster &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb21-3" title="3">cluster[[<span class="st">&quot;tscore_W1&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;school_clus&quot;</span>)   <span class="co">#teacher rating at wave 1</span></a>
<a class="sourceLine" id="cb21-4" title="4">cluster[[<span class="st">&quot;t_score&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;uniqueid&quot;</span>,<span class="st">&quot;school_clus&quot;</span>) <span class="co"># the outcome</span></a>
<a class="sourceLine" id="cb21-5" title="5">cluster[[<span class="st">&quot;prev_sdq&quot;</span>]] &lt;-<span class="st">  </span><span class="kw">c</span>(<span class="st">&quot;uniqueid&quot;</span>,<span class="st">&quot;school_clus&quot;</span>)   <span class="co">#the auxiliary variable</span></a>
<a class="sourceLine" id="cb21-6" title="6">cluster[[<span class="st">&quot;prev_dep&quot;</span>]] &lt;-<span class="st">  </span><span class="kw">c</span>(<span class="st">&quot;uniqueid&quot;</span>,<span class="st">&quot;school_clus&quot;</span>)  <span class="co">#the exposure</span></a></code></pre></div>
<p>Then the imputation model can be specified as follows:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">imp &lt;-<span class="st"> </span><span class="kw">mice</span>(CATS_dataL, <span class="dt">method =</span> impMethod, <span class="dt">predictorMatrix =</span> predMatrix, <span class="dt">maxit =</span> <span class="dv">1</span>, </a>
<a class="sourceLine" id="cb22-2" title="2">            <span class="dt">m =</span> <span class="dv">3</span>, <span class="dt">levels_id =</span> cluster, <span class="dt">variables_levels =</span> level,</a>
<a class="sourceLine" id="cb22-3" title="3">            <span class="dt">aggregate_automatically =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb22-4" title="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb22-5" title="5"><span class="co">#&gt;  iter imp variable</span></a>
<a class="sourceLine" id="cb22-6" title="6"><span class="co">#&gt;   1   1  tscore_W1  prev_dep  t_score  prev_sdq</span></a>
<a class="sourceLine" id="cb22-7" title="7"><span class="co">#&gt;   1   2  tscore_W1  prev_dep  t_score  prev_sdq</span></a>
<a class="sourceLine" id="cb22-8" title="8"><span class="co">#&gt;   1   3  tscore_W1  prev_dep  t_score  prev_sdq</span></a></code></pre></div>
<p>Post-imputation, no reshape is required as the data was imputed in long format and the anlysis can be carried out on the imputed data.</p>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
